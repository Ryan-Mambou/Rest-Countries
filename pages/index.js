import Head from "next/head";
import Layout from "../components/Layout";
import Search from "../components/Search";
import { useEffect, useState } from "react";
import Filter from "../components/Filter";
import axios from "axios";
import CountryList from "../components/CountryList";
import _ from "lodash";
import { useTheme } from "next-themes";

export async function getStaticProps() {
  const data = await axios.get("https://restcountries.com/v3.1/all");

  return {
    props: {
      countries: data.data,
    },
  };
}

export default function Home({ countries }) {
  const [dropdown, showDropdown] = useState(false);
  const [query, setQuery] = useState("");
  const [continentToSort, setContinentToSort] = useState("");
  const sorted = _.orderBy(countries, (item) => item.name.common, ["asc"]);
  const [darkMode, setDarkMode] = useState(false);

  //Function for search filter for region
  /** 
  const filterdByRegion = (array) => {
  return array.filter(
    (el) => 
    el.region.includes(continentToSort) && el.name.common.toLowerCase().includes(query)
  )
  }*/

  //Function for multiple search filter
  const multipleSearch = (array) => {
    return array.filter(
      (el) =>
        el.region.includes(continentToSort) &&
        Object.keys(el).some((parameter) =>
          el[parameter].toString().toLowerCase().includes(query)
        )
    );
  };

  const filtered = multipleSearch(sorted);

  const handleChange = (e) => {
    setQuery(e.target.value);
  };

  const toggleDarkMode = () => {
    setDarkMode(!darkMode);
  };

  const changeTheme = () => {
    setTheme(theme === "light" ? "dark" : "light");
  };

  const handleDropdown = () => {
    showDropdown(!dropdown);
  };

  const closeDropdown = () => {
    showDropdown(false);
  };

  return (
    <div className={`font-nunito bg-gray-100 dark:bg-slate-900 min-h-screen`}>
      <Head>
        <title>Rest Countries</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Layout toggleDarkMode={toggleDarkMode} darkMode={darkMode} />
      <div className="w-11/12 m-auto mt-40 flex flex-col md:flex-row justify-between items-start md:items-center gap-5 md:gap-0">
        <Search handleChange={handleChange} />
        <Filter
          handleDropdown={handleDropdown}
          closeDropdown={closeDropdown}
          dropdown={dropdown}
          setContinentToSort={setContinentToSort}
        />
      </div>
      <CountryList countries={filtered} />
    </div>
  );
}
